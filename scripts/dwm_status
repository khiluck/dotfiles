#!/bin/bash
# Network speed stuff stolen from http://linuxclues.blogspot.sg/2009/11/shell-script-show-network-speed.html

print_cpu() {
	GETCPU=$(top -b -n1 | grep "Cpu(s)" | awk '{print $2 + $4}' | cut -f1 -d'.')
	printf "CPU:%s%%" "$GETCPU"
}


print_layout() {
	(setxkbmap -query | grep -q "layout:\s\+us") && KBD="En" || KBD="Ru"
	printf "%s" "$KBD"
}


print_mem(){
#	echo $(($(grep -m1 'MemAvailable:' /proc/meminfo | awk '{print $2}') / 1024))
	FREE_DATA=`free -m | grep Mem`
	CURRENT=`echo $FREE_DATA | cut -f3 -d' '`
	TOTAL=`echo $FREE_DATA | cut -f2 -d' '`
	PRINTMEM=$(echo "scale = 2; $CURRENT/$TOTAL*100" | bc)
	printf "RAM:%s%%" "$PRINTMEM"
}


print_hdd(){
	PRINTHDD=$(df -lh | awk '{if ($6 == "/") { print $5 }}' | head -1 | cut -d'%' -f1)
	printf "🖴 %%"
}


print_temp(){
	PRINTTEMP=$(head -c 2 /sys/devices/platform/thinkpad_hwmon/hwmon/hwmon?/temp1_input)
	printf "%s" "$PRINTTEMP"
#	sensors | awk '/temp1/ {print $2}' | cut -c2- | cut -f1 -d'.'
}


print_internet(){
	case "$(cat /sys/class/net/w*/operstate 2>/dev/null)" in
		down) wifiicon="📡 " ;;
		#up) wifiicon="$(awk '/^\s*w/ { print "📶", int($3 * 100 / 70) "% " }' /proc/net/wireless)" ;;
		up) wifiicon="$(awk '/^\s*w/ { print "📶", int($3 * 100 / 70) "% " }' /proc/net/wireless)" ;;
	esac

	printf "%s%s%s\n" "$wifiicon" "$(sed "s/down/❎/;s/up/🌐/" /sys/class/net/e*/operstate 2>/dev/null)" "$(sed "s/.*/🔒/" /sys/class/net/tun*/operstate 2>/dev/null)"
}


print_battery(){
	for battery in /sys/class/power_supply/BAT?*; do
		# If non-first battery, print a space separator.
		[ -n "${capacity+x}" ] && printf " "
		# Sets up the status and capacity
		case "$(cat "$battery/status")" in
			"Full") status="⚡" ;;
			"Discharging") status="🔋" ;;
			"Charging") status="🔌" ;;
			"Not charging") status="🛑" ;;
			"Unknown") status="♻️" ;;
		esac
		capacity=$(cat "$battery/capacity")
		# Will make a warn variable if discharging and low
		[ "$status" = "🔋" ] && [ "$capacity" -le 25 ] && warn="❗"
		# Prints the info
		printf "%s%s%d%%" "$status" "$warn" "$capacity"; unset warn
	done && exit 0

}

print_volume(){
	[ $(pamixer --get-mute) = true ] && echo 🔇 && exit

	vol="$(pamixer --get-volume)"

	if [ "$vol" -gt "70" ]; then
		icon="🔊"
	elif [ "$vol" -lt "30" ]; then
		icon="🔈"
	else
		icon="🔉"
	fi

	printf "%s%s%%" "$icon" "$vol"
}

print_brightness(){
	brlevel="$(echo "scale = 2; $(cat /sys/class/backlight/amdgpu_bl0/brightness)/250*100" | bc | cut -f1 -d'.')"
	if [ "$brlevel" -gt "50" ]; then
		icon="🔆"
	else
		icon="🔅"
	fi

	printf "%s%s%%" "$icon" "$brlevel"
}



print_date(){
	PRINTDATE=$(date "+%d-%b-%y | 🕙%H:%M")
	printf "🗓️ %s" "$PRINTDATE"
}

print_rec(){
	[ -f /tmp/screencast ] && printf " ⏺️"
}

print_webcam(){
	[ -f /tmp/webcam ] && printf " 📸"
}


while true
do
	xsetroot -name "$(print_rec)$(print_webcam) ⌨ $(print_layout) | $(print_battery) | $(print_brightness) | $(print_volume) | $(print_internet) | $(print_date)"
	sleep 60s
done



