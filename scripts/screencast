#!/bin/bash

FILENAME=$HOME/Videos/screencast-$(date '+%y%m%d-%H%M-%S').mp4

start_screencast(){
	touch /tmp/screencast && sleep 0.5s && refbar
	echo $FILENAME > /tmp/screencast
#	ffmpeg -y -f x11grab -framerate 10 -s "$(xdpyinfo | awk '/dimensions/ {print $2;}')" -i "$DISPLAY" -f pulse -i default -c:v h264 -crf 0 -preset ultrafast -r 10 -c:a aac "$FILENAME" &
	ffmpeg -y -f x11grab -framerate 10 -s "$(xdpyinfo | awk '/dimensions/ {print $2;}')" -i "$DISPLAY" -f pulse -i alsa_input.usb-Creative_Technology_Ltd_Sound_Blaster_Play__3_00204429-00.analog-stereo -f pulse -i alsa_output.usb-Creative_Technology_Ltd_Sound_Blaster_Play__3_00204429-00.analog-stereo.monitor -filter_complex "[1][2]amerge=inputs=2[a]" -map 0:v -map "[a]" -ac 2 -c:v h264 -crf 0 -preset ultrafast -r 10 "$FILENAME" &
	echo $! > /tmp/recordingpid
}


stop_screencast(){
	rm -f /tmp/screencast && refbar
	recpid="$(cat /tmp/recordingpid)"
    # kill with SIGTERM, allowing finishing touches.
    kill -15 "$recpid"
    rm -f /tmp/recordingpid
    # even after SIGTERM, ffmpeg may still run, so SIGKILL it.
    sleep 3
    kill -9 "$recpid"
#	xrandr -s 1920x1200
	exit
}


loop_refresh(){
	while [ -f /tmp/screencast ]
	do
	  sleep 2 # or less like 0.2
	  refbar
	done
}


[ -f /tmp/screencast ] && stop_screencast 
start_screencast && loop_refresh

