#!/bin/bash

set -euo pipefail

FILENAME="$HOME/Videos/screencast-$(date '+%y%m%d-%H%M-%S').mp4"

start_screencast(){
  # Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÐºÐ¸ "recording"
  pactl list short sinks | awk '{print $2}' | grep -qx recording || micplusspeakers.sh

  touch /tmp/screencast && sleep 0.5s && refbar
  echo "$FILENAME" > /tmp/screencast

  # ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð²Ð¸Ð´ÐµÐ¾/Ð°ÑƒÐ´Ð¸Ð¾
  VIDEO_SIZE="$(xdpyinfo | awk '/dimensions/ {print $2;}')"

  # ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð°Ð¿Ð¿Ð°Ñ€Ð°Ñ‚Ð½Ð¾ ÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· VAAPI (AMD VCN) â€” Ñ€Ð°Ð·Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ Ð¦ÐŸ
# ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð°Ð¿Ð¿Ð°Ñ€Ð°Ñ‚Ð½Ð¾ ÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· VAAPI (AMD VCN)
	if [ -e /dev/dri/renderD128 ] && ffmpeg -hide_banner -hwaccels 2>/dev/null | grep -qi vaapi; then
	  VIDEO_CODEC=(-vaapi_device /dev/dri/renderD128 \
	               -vf "format=nv12,hwupload" \
    	           -c:v h264_vaapi -qp 21 -bf 2 -g 60 -r 30)
	else
	  VIDEO_CODEC=(-c:v libx264 -crf 21 -preset veryfast -pix_fmt yuv420p -r 30)
	fi

  # ÐÐµÐ±Ð¾Ð»ÑŒÑˆÐ¸Ðµ, Ð½Ð¾ Ð²Ð°Ð¶Ð½Ñ‹Ðµ Ð±ÑƒÑ„ÐµÑ€Ñ‹ + Ð²Ñ‹Ñ€Ð°Ð²Ð½Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð°ÑƒÐ´Ð¸Ð¾ Ð¿Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
  # ÐœÐ¾Ð¶Ð½Ð¾ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¿Ð¾Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ ÑƒÐ¼ÐµÑ€ÐµÐ½Ð½ÑƒÑŽ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÑƒ Ñƒ Pulse: PULSE_LATENCY_MSEC=60
  PULSE_LATENCY_MSEC=60 ffmpeg -y \
    -f x11grab -thread_queue_size 4096 -framerate 30 -s "$VIDEO_SIZE" -i "$DISPLAY" \
    -f pulse   -thread_queue_size 4096 -i recording.monitor \
    "${VIDEO_CODEC[@]}" \
    -map 0:v:0 -map 1:a:0 \
    -c:a aac -b:a 160k -ar 48000 -ac 2 \
    -af "aresample=async=1:min_hard_comp=0.100:first_pts=0,highpass=f=40,lowpass=f=16000,afftdn=nr=8:nf=-30" \
    -movflags +faststart \
    "$FILENAME" &

  echo $! > /tmp/recordingpid
}

stop_screencast(){
  echo "ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ loopback Ð¸ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ðµ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð° (PipeWire/PulseAudio)..."
  modules=$(pactl list short modules | grep -E 'module-loopback|module-null-sink|module-combine-sink' | cut -f1)
  if [ -z "$modules" ]; then
    echo "âœ… ÐÐµÑ‚ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹ Ð´Ð»Ñ Ð²Ñ‹Ð³Ñ€ÑƒÐ·ÐºÐ¸."
  else
    for id in $modules; do
      pactl unload-module "$id" && echo "ðŸ§¹ Ð’Ñ‹Ð³Ñ€ÑƒÐ¶ÐµÐ½ Ð¼Ð¾Ð´ÑƒÐ»ÑŒ ID $id"
    done
    echo "âœ… ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°."
  fi

  rm -f /tmp/screencast && refbar
  recpid="$(cat /tmp/recordingpid)"
  kill -15 "$recpid" || true
  rm -f /tmp/recordingpid
  sleep 3
  kill -9 "$recpid" 2>/dev/null || true
  exit
}

loop_refresh(){
  while [ -f /tmp/screencast ]; do
    sleep 2
    refbar
  done
}

[ -f /tmp/screencast ] && stop_screencast
start_screencast && loop_refresh

